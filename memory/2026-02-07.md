# 2026-02-07 - Memory Log

## Notion Integration Complete ‚úÖ

Successfully integrated Notion Todo database with OpenClaw.

### Database Details
- **Database ID:** `1fbf82d0-39f8-80b1-9182-cdb5ac44f31e`
- **API Key:** `NOTION_API_KEY_REDACTED`

### Property IDs (for API queries)
- **Status:** `3E6J` (select: Next Up, In Progress, Completed, End)
- **Priority:** `rqJ'` (select: High üî•, Medium, Low)
- **Due Date:** `z.OF` (date)
- **Name:** `title` (title type)
- **Effort:** `%3EYg%5E` (select: S, M, L)
- **URL:** `%3AdJp`
- **Assign:** `F%24%23%5D`
- **Date Created:** `DrOp`

### Query Examples
Filter by status:
```python
payload = {
    'filter': {
        'property': '3E6J',
        'select': {'equals': 'In Progress'}
    }
}
```

Sort by due date:
```python
payload = {
    'sorts': [{'property': 'z.OF', 'direction': 'ascending'}]
}
```

### Current Tasks (as of today)

**In Progress (5):**
1. Plan for re-brand Resume - High üî• - Due: Feb 7 ‚ö†Ô∏è TODAY
2. UX P'bas - High üî• - Due: Feb 8
3. Internship Dime! Registration - High üî• - Due: Feb 8
4. Internship Ascend Group Registration - High üî• - Due: Feb 8
5. SIT Seminar Pt.2 - Low - Due: Apr 30

**Next Up (6):**
1. GEN 241 BEAUTY OF LIFE - SOLO (vlog ‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß) - High üî• - Due: Feb 12
2. Deploy Capstone - High üî• - Due: Feb 13
3. Capstone Project - Medium - Due: Feb 16
4. Japanese Exam - Medium - Due: Feb 16
5. Security II Exam - Medium - Due: Feb 16
6. Japan wrtiting - High üî• - Due: Feb 21

### Technical Notes
- Initial Python script issues with nested property access (`NoneType` errors)
- Solution: Use property names directly (e.g., `props.get('Name', {})`) instead of IDs for cleaner code
- API filter works with property ID `3E6J` for Status
- Notion API version: `2022-06-28`

## Google Calendar (gog helper)
- Working correctly
- Account: golfpopmei14@gmail.com
- Helper script at: `/root/.openclaw/workspace/skills/gog/gog_helper.py`

---

## Banking Webhook Server Project üè¶

Oscar requested a full implementation of a **Go-based Banking Transaction Webhook Server** with PostgreSQL.

### Project Location
`/root/webhook-server/`

### Tech Stack
- **Language:** Go 1.21
- **Framework:** Fiber (HTTP)
- **Database:** PostgreSQL 15
- **Logging:** Zerolog
- **Metrics:** Prometheus
- **Decimal:** shopspring/decimal
- **Containerization:** Docker + docker-compose

### Architecture Overview
```
webhook-server/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îú‚îÄ‚îÄ api/          # HTTP API server (port 8080)
‚îÇ   ‚îú‚îÄ‚îÄ worker/       # Background processor (5s interval)
‚îÇ   ‚îî‚îÄ‚îÄ agent/        # Notification agent (LINE Notify)
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ config/       # Env-based config
‚îÇ   ‚îú‚îÄ‚îÄ domain/       # Models + custom errors
‚îÇ   ‚îú‚îÄ‚îÄ parser/       # Bank SMS parsers (KBank, SCB)
‚îÇ   ‚îú‚îÄ‚îÄ repository/   # PostgreSQL repos
‚îÇ   ‚îú‚îÄ‚îÄ handler/      # HTTP handlers
‚îÇ   ‚îî‚îÄ‚îÄ worker/       # Processor logic
‚îú‚îÄ‚îÄ pkg/
‚îÇ   ‚îú‚îÄ‚îÄ logger/       # Zerolog wrapper
‚îÇ   ‚îú‚îÄ‚îÄ metrics/      # Prometheus counters/histograms
‚îÇ   ‚îî‚îÄ‚îÄ notifier/     # LINE + Discord notifiers
‚îú‚îÄ‚îÄ public/           # Web UI (submit.html, categorize.html)
‚îú‚îÄ‚îÄ migrations/       # SQL schema + seed categories
‚îî‚îÄ‚îÄ docker-compose.yml
```

### Key Features Implemented
1. **Webhook ingestion** - POST /api/v1/webhook with SHA256 dedup
2. **KBank parser** - Thai regex for amounts, dates, types
3. **SCB parser** - Thai regex patterns
4. **Worker processor** - Polls pending webhooks every 5s
5. **Transaction CRUD** - List, filter, stats, categorize
6. **Category hierarchy** - Parent/child with auto path/depth triggers
7. **Dead Letter Queue** - Failed webhooks after max retries
8. **Web UI** - Beautiful Thai forms (Prompt font)
9. **Prometheus metrics** - webhooks_received, transactions_created, etc.
10. **LINE Notify** - Uncategorized transaction alerts

### Database Schema (PostgreSQL)
- `raw_webhooks` - payload, hash, status (PENDING/PROCESSING/PROCESSED/FAILED/DLQ)
- `categories` - hierarchical with keywords[], auto path trigger
- `transactions` - amount, type, bank, category_id, metadata JSONB
- `dead_letter_queue` - failed webhooks with error logs

### API Endpoints
```
POST   /api/v1/webhook                   # Submit webhook
GET    /api/v1/webhooks/pending          # List pending
GET    /api/v1/webhooks/:id              # Get single
POST   /api/v1/webhooks/:id/retry        # Retry failed

GET    /api/v1/transactions              # List (?uncategorized=true)
GET    /api/v1/transactions/stats        # Aggregates
GET    /api/v1/transactions/:id          # Get single
PATCH  /api/v1/transactions/:id/category # Update category
POST   /api/v1/categorize/bulk           # Bulk update

GET    /health, /ready, /live            # Health checks
GET    /metrics                          # Prometheus
```

### Pre-seeded Categories (Thai)
- üçΩÔ∏è Food & Dining (üõµ Delivery, ‚òï Coffee, üõí Groceries)
- üöó Transport (üöï Ride Hailing, ‚õΩ Fuel)
- üõí Shopping (üëï Fashion, üì± Electronics)
- üí∞ Income, üè† Bills, üí≥ Financial, üè• Healthcare, üéÆ Entertainment, üìö Education, üí∏ Transfer

### Files Created (27 total)
- 15 Go source files
- 4 SQL migrations
- 2 HTML templates
- 6 config/devops files (Dockerfile, docker-compose, Makefile, etc.)

### Status
‚úÖ **100% Backend Complete & Deployed**
‚úÖ **100% Frontend Complete & Deployed**

### Frontend React App (NEW)

**Tech Stack:**
- React 18 + TypeScript + Vite
- Tailwind CSS v4 (@tailwindcss/postcss)
- React Query (@tanstack/react-query)
- React Router DOM
- Recharts (charts)
- Lucide React (icons)

**Pages Created:**
- üìä **Dashboard** - StatCards (income/expense/balance/uncategorized), CategoryPieChart, Summary
- üìã **Transactions** - Full table with filters, pagination, category select
- üè∑Ô∏è **Categorize** - Card-based categorization UI with progress bar
- ‚úèÔ∏è **Submit** - SMS/manual entry form with examples
- üìà **Analytics** - Placeholder
- üîó **Webhooks** - Placeholder

**Components:**
- UI: Button, Card, Badge, Select
- Layout: Sidebar, Layout (with Outlet)
- Dashboard: StatCard, CategoryPieChart
- Transactions: TransactionTable

**Docker Deployment:**
- Dockerfile: multi-stage Node 20 ‚Üí Nginx Alpine
- nginx.conf: SPA routing + /api proxy

**Access URLs:**
| URL | Description |
|-----|-------------|
| `https://76.13.182.44.nip.io/app/` | React Frontend (auth: admin) |
| `https://76.13.182.44.nip.io/api/v1/webhook` | Public webhook |
| `http://localhost:3000` | Frontend direct |
| `http://localhost:8080` | API direct |

**Containers Running:**
- nginx-gate (80, 443)
- webhook-frontend (3000)
- webhook-api (8080)
- webhook-worker
- webhook-db (5432)

### Cron Job
Progress reminder every 10 minutes: Job ID `181b857e-6d1f-4e58-94ca-e651f09d195d`

---

## Frontend Updates (Session 2) üîß

### Issue: API PascalCase vs Frontend snake_case
- **Problem:** API returns Go-style PascalCase (`TransactionType`, `BankName`) but TypeScript expected snake_case
- **Solution:** Updated all frontend TypeScript interfaces to use PascalCase field names

### Files Updated:
1. `src/types/transaction.ts` - Changed to PascalCase (ID, Amount, TransactionType, etc.)
2. `src/components/transactions/TransactionTable.tsx` - PascalCase field access
3. `src/pages/Categorize.tsx` ‚Üí Renamed to `src/pages/Categories.tsx` - CRUD categories

### New Features Added:

**1. Dashboard Date Range Picker**
- 4 options: 7 ‡∏ß‡∏±‡∏ô, 30 ‡∏ß‡∏±‡∏ô, 90 ‡∏ß‡∏±‡∏ô, 1 ‡∏õ‡∏µ
- API endpoints updated: `/v1/transactions/stats?days=N`, `/v1/transactions/breakdown?days=N`

**2. New Webhooks Page (`/webhooks`)**
- List all raw_webhooks with filter (all/pending/failed)
- View payload details and error logs
- Retry failed webhooks
- Delete webhooks
- API: `GET /v1/webhooks`, `DELETE /v1/webhooks/:id`

**3. Categories CRUD Page (`/categories`)**
- Replaces old "Categorize" single-transaction view
- Full CRUD: Create, Read, Update, Delete
- Icon picker (20 emojis)
- Parent category selector
- Keywords input (comma-separated)
- Priority setting
- API: `GET/POST /v1/categories`, `PUT/DELETE /v1/categories/:id`

### Backend Updates:
- `internal/handler/category.go` - New CategoryHandler with CRUD
- `internal/repository/category.go` - Added Create(icon,parentID,keywords,priority), Update(full), Delete
- `internal/repository/webhook.go` - Added FindAll(status,limit), Delete
- `internal/handler/webhook.go` - Added ListWebhooks, DeleteWebhook
- `internal/repository/transaction.go` - GetStats/GetCategoryBreakdown now accept `days` param
- `cmd/api/main.go` - Registered all new routes

### Updated Route Structure:
```
GET    /api/v1/webhooks              # List all webhooks
GET    /api/v1/webhooks/pending      # Pending only
DELETE /api/v1/webhooks/:id          # Delete webhook
GET    /api/v1/categories            # List categories
POST   /api/v1/categories            # Create category
PUT    /api/v1/categories/:id        # Update category
DELETE /api/v1/categories/:id        # Delete category
GET    /api/v1/transactions/stats?days=N     # Stats with days
GET    /api/v1/transactions/breakdown?days=N # Breakdown with days
```

### Sidebar Navigation Updated:
1. Dashboard (/)
2. Transactions (/transactions)
3. Categories (/categories) - was Categorize
4. Submit (/submit)
5. Webhooks (/webhooks) - NEW
6. Analytics (/analytics)

---

## Migration to Money Manager v2.0 (Session 3) üöÄ

### MIGRATION_PLAN.md Implemented

**Renamed:** Banking Webhook Server ‚Üí **Money Manager**

### Database Changes (004_add_accounts.sql):
1. `account_group` ENUM (CASH, BANK, CREDIT, EWALLET)
2. `accounts` table with seed data:
   - KBank x1234, SCB x5678 (BANK)
   - ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (CASH)
   - TrueMoney (EWALLET)
3. New columns in `transactions`:
   - `account_id` - link to accounts
   - `is_deleted` - soft delete
   - `auto_categorized` - AI flag
   - `confidence_score` - AI confidence
4. `max_retries` in raw_webhooks
5. `ai_response` in dead_letter_queue

### Architecture Changes:
- ‚ùå **Removed:** worker, agent containers (AI Agent handles parsing)
- ‚úÖ **Added:** AI Agent skill for OpenClaw to parse SMS

### New API Endpoints:

**Accounts CRUD:**
```
GET    /api/v1/accounts
GET    /api/v1/accounts/:id
POST   /api/v1/accounts
PUT    /api/v1/accounts/:id
DELETE /api/v1/accounts/:id
```

**AI Agent Endpoints:**
```
PATCH  /api/v1/webhooks/:id/status      # Mark PROCESSED/FAILED
POST   /api/v1/transactions             # Create with account_id, confidence_score
DELETE /api/v1/transactions/:id         # Soft delete
GET    /api/v1/dashboard/summary        # Monthly summary with account breakdown
```

### Frontend Updates:
1. **Dashboard** - Added account breakdown card (by_account from summary API)
2. **Accounts Page** (`/accounts`) - Full CRUD with grouped display
3. **Sidebar** - Added Accounts link with Wallet icon
4. **Fixed emoji duplication** - Removed duplicate Icon display in dropdowns

### K+ Parser Created:
**File:** `/root/webhook-server/internal/parser/kplus.go`

**Supported format:**
```
K PLUS|‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤|‡∏ö‡∏±‡∏ç‡∏ä‡∏µ xxx-x-x5427-x ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô 50.00 ‡∏ö‡∏≤‡∏ó ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7 ‡∏Å.‡∏û. 69 22:27 ‡∏ô.
K PLUS|‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô/‡∏ñ‡∏≠‡∏ô|‡∏ö‡∏±‡∏ç‡∏ä‡∏µ xxx-x-x5427-x ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô 50.00 ‡∏ö‡∏≤‡∏ó ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7 ‡∏Å.‡∏û. 69 22:26 ‡∏ô.
```

**Features:**
- Pipe-delimited format parsing
- Thai month conversion (‡∏°.‡∏Ñ., ‡∏Å.‡∏û., ‡∏°‡∏µ.‡∏Ñ., etc.)
- Buddhist year conversion (69 ‚Üí 2569 ‚Üí 2026)
- Transaction type detection: ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤=INCOME, ‡πÇ‡∏≠‡∏ô/‡∏ñ‡∏≠‡∏ô=EXPENSE

### Webhook Endpoint:
```bash
POST https://76.13.182.44.nip.io/api/v1/webhook
Content-Type: application/json

{
  "text": "K PLUS|‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤|‡∏ö‡∏±‡∏ç‡∏ä‡∏µ xxx-x-x5427-x ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô 50.00 ‡∏ö‡∏≤‡∏ó ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7 ‡∏Å.‡∏û. 69 22:27 ‡∏ô.",
  "source": "NOTI"
}
```

### Bug Fixes:
1. **Transactions API 500 error** - Fixed NULL field scanning with COALESCE()
2. **Emoji duplication** - Removed `{cat.Icon}` from dropdowns since `{cat.Name}` already includes emoji
3. **Nginx 502** - Container IP changes after rebuild, fixed with `docker restart nginx-gate`

### AI Agent Skill:
**Location:** `~/.openclaw/workspace/skills/money-manager/SKILL.md`

**Workflow:**
1. Poll: `GET /api/v1/webhooks/pending`
2. Parse SMS text (K+, KBank, SCB formats)
3. Create: `POST /api/v1/transactions`
4. Mark: `PATCH /api/v1/webhooks/:id/status {"status":"PROCESSED"}`

### Current Data (2026-02-07):
- **‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö:** ‡∏ø1,550
- **‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢:** ‡∏ø599
- **‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:** ‡∏ø951
- **Accounts with transactions:** KBank, SCB

### URLs:
- Dashboard: https://76.13.182.44.nip.io/app/
- Accounts: https://76.13.182.44.nip.io/app/accounts
- Webhook API: https://76.13.182.44.nip.io/api/v1/webhook (no auth)
- Auth: admin / admin123

### Files Created/Modified:
- `/root/webhook-server/internal/parser/kplus.go` - NEW K+ parser
- `/root/webhook-server/internal/domain/models.go` - Added AccountID, IsDeleted to Transaction
- `/root/webhook-server/internal/repository/transaction.go` - Fixed NULL handling, added Create/Delete/GetDashboardSummary
- `/root/webhook-server/internal/handler/transaction.go` - Added CreateTransaction, DeleteTransaction, GetDashboardSummary
- `/root/webhook-server/Dockerfile` - Simplified to API only
- `/root/docker-compose.yml` - Removed worker/agent services
- `/root/webhook-server/DOCUMENTATION.md` - Complete rewrite for v2.0
- `~/.openclaw/workspace/skills/money-manager/SKILL.md` - AI Agent skill

---

## Session 4 Updates

### Webhooks Management Page Enhanced
- Added **Approve** button ‚Üí opens form with auto-parsed data
- Added **Skip** button ‚Üí mark PROCESSED without creating transaction
- Smart parser detects: bank, type, amount, date, category from SMS text

### Auto-Parse Logic (Frontend)
```javascript
// Detect bank from text
K PLUS, MAKE by KBank ‚Üí account_id: 1 (KBank)
SCB ‚Üí account_id: 2
TrueMoney ‚Üí account_id: 4

// Detect type
‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤, ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ‚Üí INCOME
‡πÇ‡∏≠‡∏ô/‡∏ñ‡∏≠‡∏ô, ‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏≠‡∏ô, ‡∏à‡πà‡∏≤‡∏¢ ‚Üí EXPENSE

// Detect category
7-eleven, coffee ‚Üí Food (1)
grab, bts ‚Üí Transport (2)
shopee, lazada ‚Üí Shopping (3)
```

### Notion Integration Fixed
- Database ID: `1fbf82d039f880b19182cdb5ac44f31e` (no dashes)
- Fixed NULL handling in priority sort
- `todo [max_items]` command now filters "Next Up" + "In Progress" only
- Shows deadline with smart display (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!, ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ, ‡∏≠‡∏µ‡∏Å X ‡∏ß‡∏±‡∏ô, ‡πÄ‡∏•‡∏¢ X ‡∏ß‡∏±‡∏ô!)

### Cron Jobs Created
1. **Morning Briefing** (07:00 ‡πÑ‡∏ó‡∏¢)
   - Calendar today + Notion active tasks
   - Sends to Discord

2. **Webhook Processor** (20:00 ‡πÑ‡∏ó‡∏¢)
   - Fetch & process pending webhooks
   - Silent (no announcement)

3. **Transaction Summary** (21:00 ‡πÑ‡∏ó‡∏¢)
   - Show pending webhooks to Oscar
   - Ask for category/note
   - Oscar replies simply: "1: ‡∏≠‡∏≤‡∏´‡∏≤‡∏£" or "‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏¢‡πá‡∏ô"
   - Prem creates transaction + marks PROCESSED

### User Interaction Example
```
Prem: üí∞ ‡∏°‡∏µ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£:
      1Ô∏è‚É£ K PLUS ‡πÇ‡∏≠‡∏ô/‡∏ñ‡∏≠‡∏ô -‡∏ø50 (22:26)
      ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏≠‡∏∞‡πÑ‡∏£? Note?

Oscar: ‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏¢‡πá‡∏ô

Prem: ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß! -‡∏ø50 ‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏¢‡πá‡∏ô (üçΩÔ∏è Food)
```

### Files Modified
- `/root/webhook-server/frontend/src/pages/Webhooks.tsx` - Full rewrite with smart parser
- `/root/.openclaw/workspace/skills/notion-skill/notion_helper.py` - Fixed todo command
